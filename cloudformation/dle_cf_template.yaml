AWSTemplateFormatVersion: 2010-09-09
Description: >-
  AWS CloudFormation template DLE_Instance_Host: Creates a single EC2 instance based on DLE AMI,
  performs initial DLE componets configuration, starts data retrival and makes this ready for clonning.
  You will be billed for the AWS resources used if you create a stack from this template.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - 
        Label:
          default: "EC2 Configuration"
        Parameters:
          - InstanceType
          - ZFSVolumeSize
          - SSHLocation
          - KeyName  
      - 
        Label:
          default: "DLE configuration"
        Parameters:
          - SourceType
          - DLERetrievalRefreshTimetable
          - PostgresDumpParallelJobs
          - DLEVerificationToken
          - DLEDebugMode
      - 
        Label:
          default: "Source Postges Parameters"
        Parameters:
          - SourcePostgresHost
          - SourcePostgresPort
          - SourcePostgresUsername
          - SourcePostgresPassword
          - SourcePostgresDBName
          - SourcePostgresVersion
          - PostgresConfigSharedPreloadLibraries
      -
        Label:
          default: "S3 backet with dump"
        Parameters:
          - SourceDumpS3Bucket   
    ParameterLabels:
      KeyName:
        default: "Key pair"
      InstanceType:
        default: "Instance type" 
      SSHLocation:
        default: "Connection source IP range"
      ZFSVolumeSize:
        defualt: "EBS volume size used for ZFS"
      DLEDebugMode:
        default: "DLE debug mode"
      DLEVerificationToken:
        default: "DLE verification token"
      DLERetrievalRefreshTimetable:
        default: "DLE retrieval refresh timetable"       
      SourceType:
        default: "Data source type"
      PostgresDumpParallelJobs:
        default: "Number of pg_dump jobs"
      SourcePostgresDBName:
        default: "Database name"
      SourcePostgresVersion:
        default: "Postgres version"
      SourcePostgresHost:
        default: "Host name or IP"
      SourcePostgresPort:
        default: "Port"
      SourcePostgresUsername:
        default: "User name"
      SourcePostgresPassword:
        default: "Password"
      PostgresConfigSharedPreloadLibraries:
        default: "shared_preload_libraries parameter"

Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: Can contain only ASCII characters.
  InstanceType:
    Description: DLE EC2 instance type
    Type: String
    Default: t2.small
    AllowedValues:
      - t1.micro
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - m1.small
      - m1.medium
      - m1.large
      - m1.xlarge
      - m2.xlarge
      - m2.2xlarge
      - m2.4xlarge
      - m3.medium
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - c1.medium
      - c1.xlarge
      - c3.large
      - c3.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - c3.8xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - g2.2xlarge
      - g2.8xlarge
      - r3.large
      - r3.xlarge
      - r3.2xlarge
      - r3.4xlarge
      - r3.8xlarge
      - i2.xlarge
      - i2.2xlarge
      - i2.4xlarge
      - i2.8xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - d2.8xlarge
      - hi1.4xlarge
      - hs1.8xlarge
      - cr1.8xlarge
      - cc2.8xlarge
      - cg1.4xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  SSHLocation:
    Description: The IP address range that can be used to SSH to the EC2 instances
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x
  ZFSVolumeSize:
    Description: The size of the EBS volumes used for DLE ZFS pool
    Type: String
    Default: 40
  DLEDebugMode:
    Description: Enables DLE debug mode
    Type: String
    Default: True
    AllowedValues:
      - True
      - False
  DLEVerificationToken:
    Description: DLE verification token
    Type: String
    Default: "example-verification-token" 
    MinLength: '9'
    MaxLength: '18'
  DLERetrievalRefreshTimetable:
    Description: DLE refresh schedule on cron format
    Type: String
    Default: '0 0 * * *'
  SourcePostgresDBName:
    Description: Ssource database name 
    Type: String
    Default: 'postgres'
  SourcePostgresVersion:
    Description: Source databadse Postgres version
    Type: String
    Default: 12
    AllowedValues:
      - 9.6
      - 10
      - 11
      - 12
      - 13
      - 14
  SourceType:
    Description: Postgres dump source
    Type: String
    Default: S3 bucket
    AllowedValues:
      - S3 bucket
      - Postgres database connection
  SourcePostgresHost:
    Description: Source Postgres cluster host name or IP
    Type: String
    Default: ''
  SourcePostgresPort:
    Description: Source Postgres cluster port
    Type: String
    Default: 5432
  SourcePostgresUsername:
    Description: Source Postgres cluster username
    Type: String
    Default: postgres
  SourcePostgresPassword:
    Description: Source Postgres cluster password
    Type: String
    Default: ''
    NoEcho: true
  PostgresConfigSharedPreloadLibraries:
    Description: Source Postgres shared_preload_libraries value
    Type: String
    Default: ''
  SourceDumpS3Bucket:
    Description: S3 bucket with pg_dump to restore
    Type: String
    Default: ''
  PostgresDumpParallelJobs:
    Description: Number of jobs to run pg_dump against the source database 
    Type: String
    Default: '1'
Mappings:
  AWSInstanceType2Arch:
    t1.micro:
      Arch: HVM64
    t2.nano:
      Arch: HVM64
    t2.micro:
      Arch: HVM64
    t2.small:
      Arch: HVM64
    t2.medium:
      Arch: HVM64
    t2.large:
      Arch: HVM64
    m1.small:
      Arch: HVM64
    m1.medium:
      Arch: HVM64
    m1.large:
      Arch: HVM64
    m1.xlarge:
      Arch: HVM64
    m2.xlarge:
      Arch: HVM64
    m2.2xlarge:
      Arch: HVM64
    m2.4xlarge:
      Arch: HVM64
    m3.medium:
      Arch: HVM64
    m3.large:
      Arch: HVM64
    m3.xlarge:
      Arch: HVM64
    m3.2xlarge:
      Arch: HVM64
    m4.large:
      Arch: HVM64
    m4.xlarge:
      Arch: HVM64
    m4.2xlarge:
      Arch: HVM64
    m4.4xlarge:
      Arch: HVM64
    m4.10xlarge:
      Arch: HVM64
    c1.medium:
      Arch: HVM64
    c1.xlarge:
      Arch: HVM64
    c3.large:
      Arch: HVM64
    c3.xlarge:
      Arch: HVM64
    c3.2xlarge:
      Arch: HVM64
    c3.4xlarge:
      Arch: HVM64
    c3.8xlarge:
      Arch: HVM64
    c4.large:
      Arch: HVM64
    c4.xlarge:
      Arch: HVM64
    c4.2xlarge:
      Arch: HVM64
    c4.4xlarge:
      Arch: HVM64
    c4.8xlarge:
      Arch: HVM64
    r3.large:
      Arch: HVM64
    r3.xlarge:
      Arch: HVM64
    r3.2xlarge:
      Arch: HVM64
    r3.4xlarge:
      Arch: HVM64
    r3.8xlarge:
      Arch: HVM64
    i2.xlarge:
      Arch: HVM64
    i2.2xlarge:
      Arch: HVM64
    i2.4xlarge:
      Arch: HVM64
    i2.8xlarge:
      Arch: HVM64
    d2.xlarge:
      Arch: HVM64
    d2.2xlarge:
      Arch: HVM64
    d2.4xlarge:
      Arch: HVM64
    d2.8xlarge:
      Arch: HVM64
    hi1.4xlarge:
      Arch: HVM64
    hs1.8xlarge:
      Arch: HVM64
    cr1.8xlarge:
      Arch: HVM64
    cc2.8xlarge:
      Arch: HVM64
  AWSRegionArch2AMI:
    eu-north-1:
      HVM64: ami-081887cbd4ae7185f
    ap-south-1:
      HVM64: ami-0bddbd3ec5d558943
    eu-west-3:
      HVM64: ami-052460c22a01cd753
    eu-west-2:
      HVM64: ami-04f292b00b02878fb
    eu-west-1:
      HVM64: ami-051b242c0685a2a0a
    ap-northeast-3:
      HVM64: ami-01d4b3bdb07544d3b
    ap-northeast-2:
      HVM64: ami-0b74271f84354121e
    ap-northeast-1:
      HVM64: ami-06e9318c86a7bd3cb
    sa-east-1:
      HVM64: ami-07e1a750e8779f490
    ca-central-1:
      HVM64: ami-0fbb25015660a32fe
    ap-southeast-1:
      HVM64: ami-04933b42f349e54c6
    ap-southeast-2:
      HVM64: ami-06357c78fa8690ba7
    eu-central-1:
      HVM64: ami-086d7d4e6d34451ad
    us-east-1:
      HVM64: ami-074808abc8d765331
    us-east-2:
      HVM64: ami-0d62c866f9add835d
    us-west-1:
      HVM64: ami-0df8bef65801e5602
    us-west-2:
      HVM64: ami-0ab2c332753acfe0c
Resources:
  ZFSVolume:
    Type: AWS::EC2::Volume
    DeletionPolicy: Snapshot
    Properties:
      Encrypted: True
      AvailabilityZone: !GetAtt DLEInstance.AvailabilityZone
      Size: !Ref ZFSVolumeSize
      Tags:
        -
          Key: Name
          Value: dle-zfs-volume
      VolumeType: gp2
  DLEInstance:
    Type: 'AWS::EC2::Instance'
    Properties:
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref InstanceType
          - Arch
      InstanceType: !Ref InstanceType
      SecurityGroups:
        - !Ref DLESecurityGroup
      KeyName: !Ref KeyName
      Tags:
        -
          Key: Name
          Value: "DLE Instance"
      UserData:
        Fn::Base64: !Sub |     # No more Fn::Join needed
          #!/bin/bash
          echo "Testing Userdata" > /tmp/1
          sudo zpool create -f \
            -O compression=on \
            -O atime=off \
            -O recordsize=128k \
            -O logbias=throughput \
            -m /var/lib/dblab/dblab_pool \
             dblab_pool \
            /dev/xvdh

  MountPoint:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      InstanceId: !Ref DLEInstance
      VolumeId: !Ref ZFSVolume
      Device: /dev/xvdh
  DLESecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable ssh access via port 22
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
Outputs:
  WebsiteURL:
    Description: URL for newly created DLE instance
    Value: !Join 
      - ''
      - - 'http://'
        - !GetAtt 
          - DLEInstance
          - PublicDnsName
